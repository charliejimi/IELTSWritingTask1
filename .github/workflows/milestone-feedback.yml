name: IELTS AI Feedback

on:
issues:
types: [closed]

jobs:
milestone-feedback:
runs-on: ubuntu-latest
permissions:
issues: write

steps:
  - name: Generate AI Feedback
    id: ai_feedback
    env:
      ISSUE_BODY: ${{ github.event.issue.body }}
    run: |
      # è®€å–æ•´å€‹ Issue å…§å®¹ï¼Œä¸¦å°‡å…¶ä½œç‚º Prompt çš„ä¸€éƒ¨åˆ†å‚³é€çµ¦ AI
      # é€™æ¨£ AI æ‰èƒ½æ ¹æ“šä½ çš„è‡ªè©•å’Œåˆ†æï¼Œæä¾›æ›´ç²¾æº–çš„å›é¥‹
      PROMPT_TEXT="æˆ‘å€‘å‰›å®Œæˆä¸€å€‹é›…æ€å¯«ä½œä»»å‹™ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šçµ¦äºˆå›é¥‹ã€‚è«‹ä½ æ‰®æ¼”ä¸€ä½è³‡æ·±é›…æ€æ•™ç·´ï¼Œé‡å°æ–‡ç« çš„å¯«ä½œåŠªåŠ›ç¨‹åº¦ã€è‡ªè©•èˆ‡ AI è©•åˆ†çš„å·®ç•°ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚
      \n---\n
      ä»¥ä¸‹æ˜¯ Issue å…§å®¹ï¼š\n
      ${{ env.ISSUE_BODY }}
      \n---\n"
      
      feedback=$(curl -s -X POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
        -H "Content-Type: application/json" \
        -d '{
          "systemInstruction": {
            "parts": [
              {
                "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›…æ€æ•™ç·´ã€‚è«‹é‡å°å‰›å®Œæˆçš„é›…æ€å¯«ä½œä»»å‹™ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚"
              }
            ]
          },
          "contents": [
            {
              "role": "user",
              "parts": [
                {
                  "text": "'"$PROMPT_TEXT"'"
                }
              ]
            }
          ]
        }' | jq -r '.candidates[0].content.parts[0].text')
      
      # å°‡å›é¥‹å…§å®¹è¼¸å‡ºç‚ºæ­¥é©Ÿçš„ output
      echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
      echo "$feedback" >> "$GITHUB_OUTPUT"
      echo "EOF" >> "$GITHUB_OUTPUT"

  - name: Post AI feedback to the issue
    uses: peter-evans/create-or-update-comment@v4
    with:
      token: ${{ secrets.GITHUB_TOKEN }}
      issue-number: ${{ github.event.issue.number }}
      body: |
        ---
        ### ğŸ‰ ä»»å‹™å®Œæˆï¼AI å°ˆæ¡ˆæ•™ç·´å›é¥‹ï¼š
        
        ${{ steps.ai_feedback.outputs.feedback }}
        ---