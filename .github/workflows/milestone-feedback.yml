# å·¥ä½œæµç¨‹åç¨±
name: IELTS AI Feedback

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ issue è¢«é—œé–‰æ™‚åŸ·è¡Œ
# ä¿®æ­£äº† 'on' è§¸ç™¼å™¨çš„ç¸®æ’èªæ³•
on:
  issues:
    types: [closed]

# å®šç¾©å·¥ä½œ
jobs:
  milestone-feedback:
    # é‹è¡Œçš„è™›æ“¬æ©Ÿç’°å¢ƒ
    runs-on: ubuntu-latest
    # è¨­å®šæ¬Šé™ï¼Œå…è¨± action è®€å– issue å…§å®¹ä¸¦å¯«å…¥ç•™è¨€
    permissions:
      issues: write

    steps:
      # ç¬¬ä¸€æ­¥ï¼šç”¢ç”Ÿ AI å›é¥‹
      - name: Generate AI Feedback
        id: ai_feedback
        env:
          # å°‡ issue body å’Œ API key ä½œç‚ºç’°å¢ƒè®Šæ•¸å‚³å…¥ï¼Œæ›´å®‰å…¨ä¸”æ˜“æ–¼ç®¡ç†
          ISSUE_BODY: ${{ github.event.issue.body }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # æº–å‚™ prompt æ–‡å­—
          # ä½¿ç”¨ here-document èªæ³• (cat <<'EOF') è®“å¤šè¡Œæ–‡å­—è™•ç†æ›´ç°¡å–®æ¸…æ™°
          PROMPT_TEXT=$(cat <<EOF
          æˆ‘å€‘å‰›å®Œæˆä¸€å€‹é›…æ€å¯«ä½œä»»å‹™ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šçµ¦äºˆå›é¥‹ã€‚è«‹ä½ æ‰®æ¼”ä¸€ä½è³‡æ·±é›…æ€æ•™ç·´ï¼Œé‡å°æ–‡ç« çš„å¯«ä½œåŠªåŠ›ç¨‹åº¦ã€è‡ªè©•èˆ‡ AI è©•åˆ†çš„å·®ç•°ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚

          ---

          ä»¥ä¸‹æ˜¯ Issue å…§å®¹ï¼š

          ${ISSUE_BODY}

          ---
          EOF
          )

          # ä½¿ç”¨ printf æº–å‚™ JSON payloadï¼Œä¸¦å°‡ prompt æ³¨å…¥
          # é€™æ¨£å¯ä»¥é¿å…å›  prompt å…§å®¹ä¸­çš„ç‰¹æ®Šå­—å…ƒå°è‡´ JSON æ ¼å¼éŒ¯èª¤
          JSON_PAYLOAD=$(printf '{
            "systemInstruction": {
              "parts": [
                {
                  "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›…æ€æ•™ç·´ã€‚è«‹é‡å°å‰›å®Œæˆçš„é›…æ€å¯«ä½œä»»å‹™ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚"
                }
              ]
            },
            "contents": [
              {
                "role": "user",
                "parts": [
                  {
                    "text": "%s"
                  }
                ]
              }
            ]
          }' "$PROMPT_TEXT")

          # ç™¼é€è«‹æ±‚åˆ° Gemini API ä¸¦è§£æå›è¦†
          # å°‡ curl å’Œ jq çš„å‘½ä»¤ä¸²åœ¨ä¸€èµ·ï¼Œç›´æ¥å–å¾—çµæœ
          feedback=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" | jq -r '.candidates[0].content.parts[0].text')
          
          # å¢åŠ ä¸€å€‹ç°¡å–®çš„éŒ¯èª¤è™•ç†ï¼Œå¦‚æœ API æ²’æœ‰å›å‚³å…§å®¹ï¼Œå°±æä¾›ä¸€å€‹é è¨­è¨Šæ¯
          if [ -z "$feedback" ] || [ "$feedback" = "null" ]; then
            echo "å¾ API ç²å–å›é¥‹å¤±æ•—ã€‚"
            feedback="æŠ±æ­‰ï¼ŒAI æ•™ç·´ç›®å‰ç„¡æ³•æä¾›å›é¥‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
          fi

          # å°‡å¤šè¡Œå›é¥‹å…§å®¹å¯«å…¥ GITHUB_OUTPUT
          # é€™æ˜¯å®˜æ–¹æ¨è–¦è™•ç†å¤šè¡Œè¼¸å‡ºçš„æ–¹å¼
          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo "$feedback" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # ç¬¬äºŒæ­¥ï¼šå°‡ AI å›é¥‹ç•™è¨€åˆ° issue
      - name: Post AI feedback to the issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          # é€™å€‹ token æ˜¯ç”± GitHub Actions è‡ªå‹•æä¾›çš„ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š secret
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ---
            ### ğŸ‰ ä»»å‹™å®Œæˆï¼AI å°ˆæ¡ˆæ•™ç·´å›é¥‹ï¼š
            
            ${{ steps.ai_feedback.outputs.feedback }}
            ---
