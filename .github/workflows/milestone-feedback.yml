name: Milestone AI Feedback

on:
  issues:
    types: [closed]

jobs:
  milestone-feedback:
    runs-on: ubuntu-latest
    # ç§»é™¤æ¢ä»¶åˆ¤æ–·ï¼Œç¢ºä¿æ¯æ¬¡ Issue é—œé–‰éƒ½è§¸ç™¼
    
    permissions:
      issues: write
      contents: write

    steps:
      - name: Generate AI Feedback
        id: ai_feedback
        run: |
          feedback=$(curl -s -X POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
            -H "Content-Type: application/json" \
            -d '{
              "systemInstruction": {
                "parts": [
                  {
                    "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ˆæ¡ˆç¶“ç†èˆ‡æ•™ç·´ã€‚è«‹é‡å°å‰›å®Œæˆçš„å°ˆæ¡ˆæˆ–ä»»å‹™ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚"
                  }
                ]
              },
              "contents": [
                {
                  "role": "user",
                  "parts": [
                    {
                      "text": "æˆ‘å€‘å‰›å®Œæˆä¸€å€‹é‡Œç¨‹ç¢‘ï¼Œè«‹å¹«å¿™ç”Ÿæˆå›é¥‹ã€‚"
                    }
                  ]
                }
              ]
            }' | jq -r '.candidates[0].content.parts[0].text')
          
          # å°‡å›é¥‹å…§å®¹è¼¸å‡ºç‚ºæ­¥é©Ÿçš„ output
          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo "$feedback" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      
      - name: Post AI feedback to the milestone
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ---
            # ğŸ‰ Milestone å®Œæˆï¼AI å°ˆæ¡ˆæ•™ç·´å›é¥‹ï¼š
            ${{ steps.ai_feedback.outputs.feedback }}
            ---