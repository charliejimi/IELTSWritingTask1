# å·¥ä½œæµç¨‹åç¨±
name: IELTS AI Feedback

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ issue è¢«é—œé–‰æ™‚åŸ·è¡Œ
on:
  issues:
    types: [closed]

# å®šç¾©å·¥ä½œ
jobs:
  milestone-feedback:
    # é‹è¡Œçš„è™›æ“¬æ©Ÿç’°å¢ƒ
    runs-on: ubuntu-latest
    # è¨­å®šæ¬Šé™ï¼Œå…è¨± action è®€å– issue å…§å®¹ä¸¦å¯«å…¥ç•™è¨€
    permissions:
      issues: write

    steps:
      # ç¬¬ä¸€æ­¥ï¼šç”¢ç”Ÿ AI å›é¥‹
      - name: Generate AI Feedback
        id: ai_feedback
        env:
          # å°‡ issue body å’Œ API key ä½œç‚ºç’°å¢ƒè®Šæ•¸å‚³å…¥ï¼Œæ›´å®‰å…¨ä¸”æ˜“æ–¼ç®¡ç†
          ISSUE_BODY: ${{ github.event.issue.body }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # å°å‡ºåŸ·è¡Œçš„æ¯ä¸€è¡ŒæŒ‡ä»¤
          set -x
          
          # å¾ ISSUE_BODY ä¸­æå–æ‰€æœ‰åœ–ç‰‡ URL
          # ä½¿ç”¨ grep å’Œ Perl æ­£è¦è¡¨é”å¼ä¾†ç²¾æº–åŒ¹é… src å±¬æ€§ä¸­çš„ URL
          IMAGE_URLS=$(echo "$ISSUE_BODY" | grep -oP '<img\s+[^>]*?src="\K[^"]*')
          
          echo "---[DETECTED IMAGE URLS]---"
          echo "$IMAGE_URLS"
          echo "---[END DETECTED IMAGE URLS]---"
          
          # å°‡æ–‡å­—éƒ¨åˆ†å¾ ISSUE_BODY ä¸­åˆ†é›¢å‡ºä¾†ï¼Œç”¨æ–¼å‚³é€çµ¦ AI
          PROMPT_TEXT=$(echo "$ISSUE_BODY" | sed -r 's/<img[^>]*>//g' | sed -r 's/^[[:space:]]*//' | sed '/^$/d')
          
          # å»ºç«‹ä¸€å€‹é™£åˆ—ä¾†å„²å­˜ API è«‹æ±‚çš„å…§å®¹éƒ¨åˆ†
          PARTS_ARRAY="[]"
          
          # å°‡è™•ç†å¾Œçš„æ–‡å­—ä½œç‚ºç¬¬ä¸€éƒ¨åˆ†åŠ å…¥é™£åˆ—
          PARTS_ARRAY=$(echo "$PARTS_ARRAY" | jq --arg text "$PROMPT_TEXT" '. + [{"text": $text}]')
          
          # æª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡ URLï¼Œä¸¦é€ä¸€ä¸‹è¼‰å’Œç·¨ç¢¼
          if [ -n "$IMAGE_URLS" ]; then
            for URL in $IMAGE_URLS; do
              echo "Downloading image from: $URL"
              # ä¸‹è¼‰åœ–ç‰‡åˆ°è‡¨æ™‚æª”æ¡ˆï¼Œä¸¦è·Ÿéš¨é‡å®šå‘
              TEMP_IMAGE_FILE=$(mktemp)
              curl -s -L -o "$TEMP_IMAGE_FILE" "$URL"
              
              # ã€ä¿®æ­£ã€‘æª¢æŸ¥ä¸‹è¼‰çš„æª”æ¡ˆå¤§å°
              # å¦‚æœæª”æ¡ˆå¤ªå°ï¼ˆå°æ–¼100ä½å…ƒçµ„ï¼‰ï¼Œå¾ˆå¯èƒ½ä¸æ˜¯åœ–ç‰‡ï¼Œè€Œæ˜¯éŒ¯èª¤è¨Šæ¯ï¼Œæˆ‘å€‘å°±è·³éå®ƒ
              FILE_SIZE=$(stat -c%s "$TEMP_IMAGE_FILE")
              
              if [ "$FILE_SIZE" -gt 100 ]; then
                echo "File size is ${FILE_SIZE} bytes. Proceeding with encoding."
                # ç·¨ç¢¼è‡¨æ™‚æª”æ¡ˆçš„å…§å®¹
                BASE64_DATA=$(base64 -w 0 "$TEMP_IMAGE_FILE")
                
                if [ -n "$BASE64_DATA" ]; then
                  # å»ºç«‹åœ–ç‰‡éƒ¨åˆ†çš„ JSON ç‰©ä»¶
                  IMAGE_PART=$(jq -n --arg data "$BASE64_DATA" '{"inlineData": {"mimeType": "image/jpeg", "data": $data}}')
                  
                  # å°‡åœ–ç‰‡éƒ¨åˆ†åŠ å…¥é™£åˆ—
                  PARTS_ARRAY=$(echo "$PARTS_ARRAY" | jq '. + ['"$IMAGE_PART"']')
                  
                else
                  echo "Failed to encode image from: $URL"
                fi
              else
                echo "Downloaded file from $URL is too small (${FILE_SIZE} bytes), likely an error. Skipping."
              fi
              
              # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
              rm "$TEMP_IMAGE_FILE"
            done
          fi
          
          # å»ºç«‹å®Œæ•´çš„ JSON payload
          # ã€æœ€çµ‚ä¿®æ­£ã€‘å°‡ parts é™£åˆ—æ­£ç¢ºåœ°å·¢ç‹€åˆ° contents é™£åˆ—ä¸­
          JSON_PAYLOAD=$(jq -n \
            --argjson parts "$PARTS_ARRAY" \
            '{
              "systemInstruction": {
                "parts": [
                  {
                    "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›…æ€æ•™ç·´ã€‚è«‹é‡å°å‰›å®Œæˆçš„é›…æ€å¯«ä½œä»»å‹™ï¼Œåƒè€ƒåœ–ç‰‡å…§å®¹ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ã€‚"
                  }
                ]
              },
              "contents": [
                {
                  "parts": $parts
                }
              ]
            }')
          
          echo "---[JSON PAYLOAD]---"
          echo "$JSON_PAYLOAD"
          echo "---[END JSON PAYLOAD]---"

          # æ›´æ–°æ¨¡å‹åç¨±ç‚º gemini-2.5-flash-preview-05-20 ä»¥æ”¯æ´åœ–ç‰‡åˆ†æ
          API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -w "\n%{http_code}")
            
          HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
          API_RESPONSE=$(echo "$API_RESPONSE" | head -n -1)

          echo "---[FULL API RESPONSE]---"
          echo "$API_RESPONSE"
          echo "---[END FULL API RESPONSE]---"
          echo "HTTP Status Code: $HTTP_CODE"

          feedback=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          if [ "$HTTP_CODE" -ne 200 ] || [ -z "$feedback" ] || [ "$feedback" = "null" ]; then
            echo "å¾ API ç²å–å›é¥‹å¤±æ•—ï¼ŒHTTP Status Code: $HTTP_CODE"
            feedback="æŠ±æ­‰ï¼ŒAI æ•™ç·´ç›®å‰ç„¡æ³•æä¾›å›é¥‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚è«‹æª¢æŸ¥ä½ çš„ API é‡‘é‘°æˆ–ç¶²è·¯é€£ç·šã€‚"
          fi

          echo "---[PARSED FEEDBACK]---"
          echo "$feedback"
          echo "---[END PARSED FEEDBACK]---"

          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo "$feedback" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # ç¬¬äºŒæ­¥ï¼šå°‡ AI å›é¥‹ç•™è¨€åˆ° issue
      - name: Post AI feedback to the issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ---
            ### ğŸ‰ ä»»å‹™å®Œæˆï¼AI å°ˆæ¡ˆæ•™ç·´å›é¥‹ï¼š
            
            ${{ steps.ai_feedback.outputs.feedback }}
            ---