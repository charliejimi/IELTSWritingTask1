# å·¥ä½œæµç¨‹åç¨±
name: IELTS AI Feedback

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ issue è¢«é—œé–‰æ™‚åŸ·è¡Œ
# ä¿®æ­£äº† 'on' è§¸ç™¼å™¨çš„ç¸®æ’èªæ³•
on:
  issues:
    types: [closed]

# å®šç¾©å·¥ä½œ
jobs:
  milestone-feedback:
    # é‹è¡Œçš„è™›æ“¬æ©Ÿç’°å¢ƒ
    runs-on: ubuntu-latest
    # è¨­å®šæ¬Šé™ï¼Œå…è¨± action è®€å– issue å…§å®¹ä¸¦å¯«å…¥ç•™è¨€
    permissions:
      issues: write

    steps:
     # ç¬¬ä¸€æ­¥ï¼šæ•´åˆ Issue å…§å®¹èˆ‡ç•™è¨€ï¼Œä¸¦ç”¢ç”Ÿ AI å›é¥‹
      - name: Generate AI Feedback
        id: ai_feedback
        env:
          # å°‡ issue body å’Œ API key ä½œç‚ºç’°å¢ƒè®Šæ•¸å‚³å…¥
          ISSUE_BODY: ${{ github.event.issue.body }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # å‚³å…¥ GITHUB_TOKEN ä»¥ä¾¿è®€å– issue ç•™è¨€
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å°å‡ºåŸ·è¡Œçš„æ¯ä¸€è¡ŒæŒ‡ä»¤ï¼Œæ–¹ä¾¿é™¤éŒ¯
          set -x

          # --- [æ–°å¢] æ­¥é©Ÿ 1: é€é GitHub API æŠ“å–é€™å€‹ issue çš„æ‰€æœ‰ç•™è¨€ ---
          # ä½¿ç”¨ curl å‘¼å« GitHub API çš„ comments endpoint
          # -s: silent æ¨¡å¼
          # -H: å¸¶ä¸Šå¿…è¦çš„ headerï¼ŒåŒ…å«é©—è­‰ç”¨çš„ GITHUB_TOKEN
          COMMENTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments")

          # --- [æ–°å¢] æ­¥é©Ÿ 2: ä½¿ç”¨ jq å°‡æŠ“å›ä¾†çš„ç•™è¨€ JSON æ ¼å¼åŒ–ç‚ºæ˜“è®€çš„æ–‡å­— ---
          # map(...) | join(...) : éæ­·æ¯ä¸€å‰‡ç•™è¨€ï¼Œè½‰æ›æˆæŒ‡å®šæ ¼å¼ï¼Œæœ€å¾Œç”¨åˆ†éš”ç·šä¸²æ¥èµ·ä¾†
          # -r: è¼¸å‡ºåŸå§‹æ–‡å­— (raw output)ï¼Œè€Œéå¸¶æœ‰å¼•è™Ÿçš„ JSON å­—ä¸²
          FORMATTED_COMMENTS=$(echo "$COMMENTS_JSON" | jq -r 'map("### ç•™è¨€è€…: \(.user.login)\n\n\(.body)") | join("\n\n---\n\n")')

          # --- [æ–°å¢] æ­¥é©Ÿ 3: çµ„åˆåŸå§‹ Issue å…§æ–‡å’Œæ‰€æœ‰ç•™è¨€ï¼Œå»ºç«‹å®Œæ•´çš„å°è©±ä¸Šä¸‹æ–‡ ---
          # å°‡åŸå§‹æ–‡ç« å’Œæ ¼å¼åŒ–å¾Œçš„ç•™è¨€ä¸²æ¥åœ¨ä¸€èµ·
          FULL_CONTEXT=$(cat <<EOF
          ## é›…æ€å¯«ä½œåŸæ–‡

          ${ISSUE_BODY}

          ---

          ## æ­·å²å°è©±èˆ‡ç•™è¨€

          ${FORMATTED_COMMENTS}
          EOF
          )

          echo "---[FULL CONTEXT]---"
          echo "$FULL_CONTEXT"
          echo "---[END FULL CONTEXT]---"

          # --- [ä¿®æ”¹] æ­¥é©Ÿ 4: æº–å‚™ Promptï¼Œå‘Šè¨´ AI å®ƒçš„ä»»å‹™æ˜¯åŸºæ–¼å®Œæ•´ä¸Šä¸‹æ–‡ä¾†å›é¥‹ ---
          # æˆ‘å€‘ç¨å¾®ä¿®æ”¹äº† promptï¼Œè®“ AI çŸ¥é“å®ƒæ­£åœ¨çœ‹ä¸€æ®µå®Œæ•´çš„å°è©±ç´€éŒ„
          PROMPT_TEXT=$(cat <<EOF
          ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›…æ€æ•™ç·´ã€‚è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€Œé›…æ€å¯«ä½œåŸæ–‡ã€ä»¥åŠã€Œæ­·å²å°è©±èˆ‡ç•™è¨€ã€çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œé‡å°æœ€æ–°çš„æå•æˆ–æ–‡ç« çš„æ•´é«”è¡¨ç¾ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ã€‚è«‹è®“ä½ çš„å›é¥‹åƒæ˜¯åœ¨å»¶çºŒé€™æ®µå°è©±ã€‚

          ---

          ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼š

          ${FULL_CONTEXT}

          ---
          EOF
          )
          
          # --- [ä¿®æ”¹] æ­¥é©Ÿ 5: ä½¿ç”¨ jq å»ºç«‹ JSON payloadï¼Œå‚³å…¥çš„æ˜¯ FULL_CONTEXT ---
          JSON_PAYLOAD=$(jq -n \
            --arg prompt_text "$FULL_CONTEXT" \
            '{
              "systemInstruction": {
                "parts": [
                  {
                    "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é›…æ€æ•™ç·´ã€‚è«‹æ ¹æ“šå‰›å®Œæˆçš„é›…æ€å¯«ä½œä»»å‹™ä»¥åŠæ­·å²å°è©±ï¼Œçµ¦äºˆç°¡æ½”ã€ç²¾æº–ä¸”å…·é«”çš„æ­£å‘å›é¥‹ï¼Œä¸¦æå‡ºä¸€åˆ°å…©é»æ˜ç¢ºçš„æ”¹é€²æ–¹å‘ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è®€ï¼Œä¸¦ä¸”è¦åƒåœ¨å»¶çºŒå°è©±ä¸€æ¨£ã€‚"
                  }
                ]
              },
              "contents": [
                {
                  "role": "user",
                  "parts": [
                    {
                      "text": $prompt_text
                    }
                  ]
                }
              ]
            }')
          
          echo "---[JSON PAYLOAD]---"
          echo "$JSON_PAYLOAD"
          echo "---[END JSON PAYLOAD]---"

          # å‘¼å« API çš„éƒ¨åˆ†ç¶­æŒä¸è®Š
          API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          echo "---[FULL API RESPONSE]---"
          echo "$API_RESPONSE"
          echo "---[END FULL API RESPONSE]---"

          feedback=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          echo "---[PARSED FEEDBACK]---"
          echo "$feedback"
          echo "---[END PARSED FEEDBACK]---"
          
          if [ -z "$feedback" ] || [ "$feedback" = "null" ]; then
            echo "å¾ API ç²å–å›é¥‹å¤±æ•—ã€‚"
            feedback="æŠ±æ­‰ï¼ŒAI æ•™ç·´ç›®å‰ç„¡æ³•æä¾›å›é¥‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
          fi

          echo "feedback<<EOF" >> "$GITHUB_OUTPUT"
          echo "$feedback" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT" 
      # ç¬¬äºŒæ­¥ï¼šå°‡ AI å›é¥‹ç•™è¨€åˆ° issue
      - name: Post AI feedback to the issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          # é€™å€‹ token æ˜¯ç”± GitHub Actions è‡ªå‹•æä¾›çš„ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š secret
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ---
            ### ğŸ‰ ä»»å‹™å®Œæˆï¼AI å°ˆæ¡ˆæ•™ç·´å›é¥‹ï¼š
            
            ${{ steps.ai_feedback.outputs.feedback }}
            ---